---
format: hypermake.v0

targets:
  gotool:
    description: toolchain to build Go source code
    watches:
      - hack/gotool
    build: hack/gotool

  vendor:
    description: fetch dependencies
    after:
      - gotool
    watches:
      - codegen/vendor/manifest
    cmds:
      - 'cd codegen && gvt restore'

  codegen:
    description: build code generator
    after:
      - vendor
    watches:
      - codegen/**/**/*.go
    cmds:
      - mkdir -p bin
      - go build -o bin/protoc-gen-tbus ./codegen/cmd/protoc-gen-tbus

  gen-go:
    description: generate source code for Go
    after:
      - codegen
    watches:
      - proto
      - hack/fixpb-goimports.sh
    cmds:
      - 'export PATH=`pwd`/bin:$PATH'
      - 'protoc -Iproto --go_out=go proto/tbus/*.proto'
      - hack/fixpb-goimports.sh
      - 'protoc -Iproto --tbus_out=go,internal:go proto/tbus/*.proto'

  gen-node:
    description: generate source code for Node.js
    after:
      - codegen
    watches:
      - proto
    cmds:
      - mkdir -p node/gen
      - 'export PATH=`pwd`/bin:$PATH'
      - 'protoc -Iproto --js_out=import_style=commonjs,binary:node/gen proto/tbus/*.proto proto/common/*.proto'
      - 'protoc -Iproto --tbus_out=js,internal:node/gen proto/tbus/*.proto'

  generate:
    description: generate source code
    after:
      - 'gen-*'

settings:
  docker:
    image: 'tbus-gotool:latest'
    src-volume: /go/src/github.com/evo-bots/tbus
