---
format: hypermake.v0

targets:
  toolchain:
    description: toolchain to build Go source code
    watches:
      - hack/toolchain
    build: hack/toolchain

  vendor:
    description: fetch dependencies
    after:
      - toolchain
    watches:
      - codegen/vendor/manifest
    workdir: codegen
    cmds:
      - gvt restore

  codegen:
    description: build code generator
    after:
      - vendor
    watches:
      - codegen/**/**/*.go
    cmds:
      - mkdir -p bin
      - go build -o bin/protoc-gen-tbus ./codegen/cmd/protoc-gen-tbus
    artifacts:
      - bin/protoc-gen-tbus

  gen-go:
    description: generate source code for Go
    after:
      - codegen
    watches:
      - proto
      - hack/fixpb-goimports.sh
    cmds:
      - 'export PATH=`pwd`/bin:$PATH'
      - 'protoc -Iproto --go_out=go proto/tbus/*.proto'
      - hack/fixpb-goimports.sh
      - 'protoc -Iproto --tbus_out=go,internal:go proto/tbus/*.proto'

  gen-node:
    description: generate source code for Node.js
    after:
      - codegen
    watches:
      - proto
    cmds:
      - mkdir -p node/gen
      - 'export PATH=`pwd`/bin:$PATH'
      - 'protoc -Iproto --js_out=import_style=commonjs,binary:node/gen proto/tbus/common/*.proto'
      - 'protoc -Iproto --js_out=import_style=commonjs,binary:node/gen proto/tbus/*.proto'
      - 'protoc -Iproto --tbus_out=js,internal:node/gen proto/tbus/*.proto'

  generate:
    description: generate source code
    after:
      - 'gen-*'

  test-go:
    description: test go code
    after:
      - gen-go
    watches:
      - go/tbus
    cmds:
      - go test ./go/tbus/...

  test-node:
    description: test Node.js source code
    after:
      - gen-node
      - node-deps
    watches:
      - node
    cmds:
      - cd node
      - ./node_modules/.bin/mocha

  test:
    description: run tests
    after:
      - 'test-*'

  node-deps:
    description: install node modules
    after:
      - toolchain
    watches:
      - node/package.json
    cmds:
      - cd node
      - npm install

settings:
  docker:
    image: 'tbus-gotool:latest'
    src-volume: /go/src/github.com/evo-bots/tbus
